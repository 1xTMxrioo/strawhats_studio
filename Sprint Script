local UserInputService = game:GetService("UserInputService")
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local sliding = false
local slideWalkSpeed = 45
local slideFOV = 85
local slideDuration = 0.8

local function isSprinting()
	--check if sprinting
	local sprintScript = player:WaitForChild("PlayerScripts"):FindFirstChild("SprintScript")
	if sprintScript and sprintScript:IsA("LocalScript") then
		local character = player.Character
		if character then
			local humanoid = character:FindFirstChildOfClass("Humanoid")
			if humanoid and humanoid.WalkSpeed >= 35 then
				return true
			end
		end
	end
	return false
end

local function startSprintLoopSound()
	if not Config.EnableSounds or sprintLoopSound then return end

	local sound = Instance.new("Sound")
	sound.SoundId = Config.SprintLoopSound
	sound.Volume = Config.SprintVolume * 0.7
	sound.Looped = true
	sound.Parent = workspace.CurrentCamera
	sound:Play()
	sprintLoopSound = sound
end

local function stopSprintLoopSound()
	if sprintLoopSound then
		sprintLoopSound:Stop()
		sprintLoopSound:Destroy()
		sprintLoopSound = nil
	end
end

local function playSprintAnimation()
	if not Config.EnableAnimations or not animator then return end
	
	-- Stop current animation if playing
	if currentSprintAnimation then
		currentSprintAnimation:Stop()
		currentSprintAnimation:Destroy()
	end
	
	local animation = Instance.new("Animation")
	animation.AnimationId = Config.SprintAnimation
	currentSprintAnimation = animator:LoadAnimation(animation)
	currentSprintAnimation.Looped = true
	currentSprintAnimation.Priority = Enum.AnimationPriority.Action
	currentSprintAnimation:Play()
end

local function stopSprintAnimation()
	if currentSprintAnimation then
		currentSprintAnimation:Stop()
		currentSprintAnimation:Destroy()
		currentSprintAnimation = nil
	end
end

local function updateSprintState(isSprinting)
	if running == isSprinting then return end
	running = isSprinting

	local character = player.Character
	if not character then return end

	local humanoid = character:FindFirstChildOfClass("Humanoid")
	if not humanoid then return end
	if running then
		playSprintStartSound()
		task.wait(0.1)
		startSprintLoopSound()
		playSprintAnimation()
		for i = 1, 5 do
			workspace.CurrentCamera.FieldOfView = defaultFOV + ((sprintFOV - defaultFOV) * (i / 5))
			task.wait(0.02)
		end
		humanoid.WalkSpeed = getCurrentWalkSpeed()
	else
		stopSprintLoopSound()
		stopSprintAnimation()
		for i = 1, 5 do
			workspace.CurrentCamera.FieldOfView = sprintFOV - ((sprintFOV - defaultFOV) * (i / 5))
			task.wait(0.02)
		end
		humanoid.WalkSpeed = getCurrentWalkSpeed()
	end
end

